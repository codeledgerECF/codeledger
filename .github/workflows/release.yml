name: Create Release

# Trigger: push a tag like v0.1.0
on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: 'https://registry.npmjs.org'

      - name: Download npm package
        id: npm_download
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

          echo "Downloading @codeledger/cli@${VERSION} from npm..."

          DOWNLOAD_OK=false

          # Retry up to 5 times with backoff â€” npm publish may still be propagating
          for attempt in 1 2 3 4 5; do
            if npm pack "@codeledger/cli@${VERSION}" 2>/dev/null; then
              TARBALL=$(ls codeledger-cli-*.tgz 2>/dev/null | head -1)
              if [ -n "$TARBALL" ]; then
                echo "âœ“ Downloaded $TARBALL"
                echo "NPM_VERIFIED=true" >> "$GITHUB_ENV"
                echo "NPM_TARBALL=$TARBALL" >> "$GITHUB_ENV"
              DOWNLOAD_OK=true                
              break
              fi
            fi
            echo "Attempt $attempt: @codeledger/cli@${VERSION} not yet available, waiting..."
            sleep $((attempt * 10))
          done

          if [ "$DOWNLOAD_OK" != "true" ]; then
            echo "::error::@codeledger/cli@${VERSION} not found on npm after 5 attempts. Cannot create release without the package."
            exit 1
          fi

      - name: Verify CLI works
        run: |
          npm install -g "./${NPM_TARBALL}"
          INSTALLED_VERSION=$(codeledger --version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' || echo "unknown")
          echo "Installed CLI version: $INSTALLED_VERSION"

          if [ "$INSTALLED_VERSION" != "$VERSION" ]; then
            echo "::warning::Version mismatch â€” expected $VERSION, got $INSTALLED_VERSION"
          fi

      - name: Generate MANIFEST.md
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          TAG_DATE=$(date -u +"%Y-%m-%d")
          SHA256=$(sha256sum "${NPM_TARBALL}" | cut -d' ' -f1)

          # Read feature list from CHANGELOG.md (everything between first ## and second ##)
          CHANGELOG_SECTION=$(awk '/^## '"${VERSION}"'/{found=1; next} /^## [0-9]/{if(found) exit} found{print}' CHANGELOG.md)

          cat > MANIFEST.md << MANIFEST_EOF
          # CodeLedger v${VERSION} â€” Release Manifest

          **Release date:** ${TAG_DATE}
          **npm package:** \`@codeledger/cli@${VERSION}\`
          **npm verified:** true
          **Git tag:** v${VERSION}
          **Git commit:** $(git rev-parse --short HEAD)
          **Package checksum (SHA-256):** \`${SHA256}\`

          ---

          ## What's in this zip

          This release zip contains the **full installable package** â€” no internet connection to npm is required.

          | File | Purpose |
          |------|---------|
          | \`${NPM_TARBALL}\` | The npm package (installable offline with \`npm install -g\`) |
          | \`install.sh\` | Installs from the bundled package (with prerequisite checks) |
          | \`README.md\` | Full feature documentation and CLI reference |
          | \`GETTING-STARTED.md\` | Step-by-step setup guide |
          | \`CHANGELOG.md\` | Version history with feature details |
          | \`MANIFEST.md\` | This file â€” release contents and verification |
          | \`LICENSE\` | MIT license (CLI, types, repo scanner, harness) |
          | \`LICENSE-CORE\` | CodeLedger Core License (scoring engine binary) |

          ## How to install

          **Option A: From this zip (recommended â€” works offline)**
          \`\`\`bash
          unzip codeledger-${VERSION}.zip
          cd codeledger-${VERSION}/
          ./install.sh
          \`\`\`

          **Option B: Directly from npm**
          \`\`\`bash
          npm install -g @codeledger/cli@${VERSION}
          \`\`\`

          ## How to verify

          After installation, confirm the version matches this release:

          \`\`\`bash
          codeledger --version
          # Expected: ${VERSION}

          codeledger doctor
          # Runs 8 health checks on your installation
          \`\`\`

          ## Verify package integrity

          \`\`\`bash
          # Check the bundled package checksum
          sha256sum ${NPM_TARBALL}
          # Expected: ${SHA256}
          \`\`\`

          ## Feature verification

          To verify the v${VERSION} feature set is present in your installed CLI:

          \`\`\`bash
          # Multi-language detection (v0.5.0+)
          codeledger scan    # Should index .py, .go, .rs, .java files (not just .ts/.js)

          # Auto-scope inference (v0.5.0+)
          codeledger activate --task "Fix auth for api-gateway"
          # Should auto-scope to api-gateway/ directory if it exists

          # Agent governance (v0.4.0+)
          codeledger intent init --objective "test"
          codeledger checkpoint list
          codeledger shared-summary
          \`\`\`

          ## npm package contents

          The \`@codeledger/cli\` npm package includes all compiled packages:

          | Package | Description |
          |---------|-------------|
          | \`@codeledger/cli\` | CLI entry point and all commands |
          | \`@codeledger/types\` | Shared TypeScript types |
          | \`@codeledger/core\` | SQLite ledger for event recording |
          | \`@codeledger/core-engine\` | Scoring engine (compiled) |
          | \`@codeledger/repo\` | Repository scanning, dependency graph, language detection |
          | \`@codeledger/selector\` | File scoring, selection, governance features |
          | \`@codeledger/instrument\` | Runtime instrumentation |
          | \`@codeledger/harness\` | Benchmark execution engine |
          | \`@codeledger/cowork\` | Cowork session integration |

          ## v${VERSION} features
          ${CHANGELOG_SECTION}

          ---

          *Generated automatically by release workflow on ${TAG_DATE}.*
          MANIFEST_EOF

          # Clean leading whitespace from heredoc indentation
          sed -i 's/^          //' MANIFEST.md

      - name: Gather release assets
        run: |
          STAGING="codeledger-${VERSION}"
          mkdir -p "$STAGING"

          # Copy the actual npm package
          cp "${NPM_TARBALL}" "$STAGING/"

          # Copy distribution files
          cp install.sh "$STAGING/"
          cp GETTING-STARTED.md "$STAGING/"
          cp README.md "$STAGING/"
          cp CHANGELOG.md "$STAGING/"
          cp MANIFEST.md "$STAGING/"
          cp LICENSE "$STAGING/" 2>/dev/null || true
          cp LICENSE-CORE "$STAGING/" 2>/dev/null || true
          chmod +x "$STAGING/install.sh"

          # Create zip
          zip -r "codeledger-${VERSION}.zip" "$STAGING/"

          # Also create a generic name for the "latest" download link
          cp "codeledger-${VERSION}.zip" codeledger.zip

          echo "ZIP_VERSIONED=codeledger-${VERSION}.zip" >> "$GITHUB_ENV"
          echo "ZIP_LATEST=codeledger.zip" >> "$GITHUB_ENV"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: CodeLedger v${{ env.VERSION }}
          body: |
            ## CodeLedger v${{ env.VERSION }}

            ### Install

            **From the zip (works offline):**
            ```bash
            unzip codeledger-${{ env.VERSION }}.zip
            cd codeledger-${{ env.VERSION }}/
            ./install.sh
            ```

            **Or directly from npm:**
            ```bash
            npm install -g @codeledger/cli@${{ env.VERSION }}
            ```

            ### npm verification

            âœ… `@codeledger/cli@${{ env.VERSION }}` verified on npm and bundled in the zip.

            ### Verify after install

            ```bash
            codeledger --version    # Should show: ${{ env.VERSION }}
            codeledger doctor       # Runs 8 health checks
            ```

            ### What's in the zip

            The release zip contains the **full installable package** â€” the npm tarball is bundled so installation works offline. See `MANIFEST.md` inside the zip for checksums and feature verification steps.

            **Zip contents:** `${{ env.NPM_TARBALL }}` Â· `install.sh` Â· `README.md` Â· `GETTING-STARTED.md` Â· `CHANGELOG.md` Â· `MANIFEST.md` Â· `LICENSE` Â· `LICENSE-CORE`

            ### Links

            - ðŸ“¦ [npm: @codeledger/cli](https://www.npmjs.com/package/@codeledger/cli)
            - ðŸ“– [Getting Started Guide](https://github.com/${{ github.repository }}/blob/main/GETTING-STARTED.md)
            - ðŸ“‹ [Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          files: |
            ${{ env.ZIP_VERSIONED }}
            ${{ env.ZIP_LATEST }}
          draft: false
          prerelease: false
